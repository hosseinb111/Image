<!doctype html>
<html lang="en" data-theme="dark">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Just Another Thought That Comes True 😎 (Back4App)</title>

    <!-- Parse (Back4App) JS SDK -->
    <script src="https://unpkg.com/parse/dist/parse.min.js"></script>

    <style>
      /* ----------------------
         THEME SYSTEM (CSS VARS)
         ---------------------- */
      :root {
        --bg: #181818;
        --surface: #222222;
        --surface-2: #2a2a2a;
        --text: #f0f0f0;
        --muted: #a0a0a0;
        --accent: #8a2be2;
        --accent-hover: #7020b2;
        --success: #20c997;
        --danger: #ff6b6b;
        --shadow: 0 10px 30px rgba(0,0,0,.35);
        --ring: 0 0 0 3px rgba(138,43,226,.35);
      }
      [data-theme="light"] {
        --bg: #f7f7fb;
        --surface: #ffffff;
        --surface-2: #f0f0f4;
        --text: #1a1a1a;
        --muted: #5a5a6a;
        --accent: #6d2bd4;
        --accent-hover: #5823ad;
        --success: #0ca678;
        --danger: #d94848;
        --shadow: 0 10px 30px rgba(20,20,40,.12);
        --ring: 0 0 0 3px rgba(109,43,212,.25);
      }

      * { box-sizing: border-box; }
      html, body { height: 100%; }
      body {
        margin: 0;
        font-family: system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
        background: var(--bg);
        color: var(--text);
        display: flex;
        flex-direction: column;
        transition: background .25s ease, color .25s ease;
      }

      .app {
        max-width: 1000px;
        margin: 0 auto;
        padding: 16px;
        display: flex;
        flex-direction: column;
        min-height: 100dvh;
        gap: 16px;
      }
      header.appbar {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
      }
      .brand { display: flex; align-items: flex-start; gap: 10px; }
      .brand h1 { font-size: clamp(18px, 3vw, 24px); margin: 0; letter-spacing: .2px; color: var(--accent); }
      .brand p { margin: 0; font-size: 12px; color: var(--muted); }

      .actions { display: flex; align-items: center; gap: 8px; }
      .icon-btn { border: none; background: var(--surface); color: var(--text); padding: 10px 12px; border-radius: 12px; box-shadow: var(--shadow); cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
      .icon-btn:hover { background: var(--surface-2); }

      .card { background: var(--surface); border: 1px solid rgba(255,255,255,.08); border-radius: 20px; box-shadow: var(--shadow); padding: 16px; display: flex; flex-direction: column; gap: 12px; flex: 1; min-height: 60dvh; }
      .chat { display: flex; flex-direction: column; gap: 10px; overflow: auto; padding: 8px; border-radius: 12px; background: var(--bg); border: 1px solid rgba(255,255,255,.06); min-height: 360px; max-height: 65dvh; }

      .msg { display: grid; grid-template-columns: 40px 1fr auto; gap: 10px; background: var(--surface-2); border-radius: 14px; padding: 10px 12px; }
      .avatar { width: 40px; height: 40px; border-radius: 50%; display: grid; place-items: center; font-weight: 700; color: #fff; user-select: none; }
      .msg .meta { font-size: 12px; color: var(--muted); }
      .msg .sender { font-weight: 600; }
      .msg .text { white-space: pre-wrap; word-break: break-word; margin-top: 4px; }

      .composer { display: grid; grid-template-columns: 1fr auto; gap: 8px; }
      textarea#message-input { min-height: 56px; max-height: 160px; resize: vertical; }
      .send-btn { background: var(--accent); color: #fff; border: none; padding: 12px 18px; border-radius: 14px; cursor: pointer; font-weight: 600; }
      .send-btn:disabled { opacity: .6; cursor: not-allowed; }

      footer { text-align: center; color: var(--muted); font-size: 12px; padding: 12px 4px; }

      @media (max-width: 640px) { .msg { grid-template-columns: 36px 1fr auto; } .avatar { width: 36px; height: 36px; font-size: 12px; } }
    </style>
  </head>
  <body>
    <div class="app">
      <header class="appbar" role="banner">
        <div class="brand" aria-label="App title">
          <div>
            <h1>Free & Complicated Messenger (Back4App)</h1>
            <p>Realtime-ish chat using Back4App (Parse) • polls every 2s</p>
          </div>
        </div>
        <div class="actions">
          <button id="theme-toggle" class="icon-btn" aria-label="Toggle theme" aria-pressed="false" title="Toggle light/dark">
            <span class="icon" id="theme-icon" aria-hidden="true">🌙</span>
            <span id="theme-text" class="subtle">Dark</span>
          </button>
        </div>
      </header>

      <main class="card">
        <div style="display:flex;gap:10px;align-items:center;justify-content:space-between;">
          <div>
            <label class="subtle">Username</label>
            <input id="username" class="text-input" style="margin-left:8px; padding:8px;border-radius:8px;" placeholder="your name" />
          </div>
          <div style="text-align:right; color:var(--muted); font-size:12px;">Back4App: Client-only demo</div>
        </div>

        <div id="chat" class="chat" aria-live="polite"></div>

        <div class="composer">
          <textarea id="message-input" placeholder="Write a message..."></textarea>
          <button id="send-btn" class="send-btn">Send</button>
        </div>
      </main>

      <footer>Simple demo — don't use client-only keys in production</footer>
    </div>

    <script>
      // ---------- USER-SUPPLIED BACK4APP API KEY ----------
      // <-- You asked to put your Back4App API here. I placed your key in both APP ID and JS KEY fields.
      const BACK4APP_APP_ID = "mC0CjSyhwHrYz5rDq0XNycTftU4cOQRl2g0CiJoe";
      const BACK4APP_JS_KEY  = "mC0CjSyhwHrYz5rDq0XNycTftU4cOQRl2g0CiJoe";
      const BACK4APP_SERVER_URL = 'https://parseapi.back4app.com/';

      // Initialize Parse (Back4App)
      Parse.initialize(BACK4APP_APP_ID, BACK4APP_JS_KEY);
      Parse.serverURL = BACK4APP_SERVER_URL;

      // DOM
      const chatEl = document.getElementById('chat');
      const sendBtn = document.getElementById('send-btn');
      const inputEl = document.getElementById('message-input');
      const usernameEl = document.getElementById('username');

      // Theme handling
      const themeToggle = document.getElementById('theme-toggle');
      const themeIcon = document.getElementById('theme-icon');
      const themeText = document.getElementById('theme-text');

      function applyTheme(t){
        document.documentElement.setAttribute('data-theme', t);
        themeToggle.setAttribute('aria-pressed', t === 'light');
        themeIcon.textContent = t === 'light' ? '☀️' : '🌙';
        themeText.textContent = t === 'light' ? 'Light' : 'Dark';
        localStorage.setItem('chat_theme', t);
      }
      themeToggle.addEventListener('click', ()=>{
        const next = document.documentElement.getAttribute('data-theme') === 'light' ? 'dark' : 'light';
        applyTheme(next);
      });
      // restore
      applyTheme(localStorage.getItem('chat_theme') || 'dark');

      // restore username
      usernameEl.value = localStorage.getItem('chat_username') || '';
      usernameEl.addEventListener('change', ()=> localStorage.setItem('chat_username', usernameEl.value));

      // Escape html
      function esc(s){ return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

      // Render message
      function renderMessage(obj){
        const username = esc(obj.get('username') || 'Anon');
        const text = esc(obj.get('text') || '');
        const createdAt = obj.createdAt ? new Date(obj.createdAt).toLocaleString() : '';

        const container = document.createElement('div');
        container.className = 'msg';

        const avatar = document.createElement('div');
        avatar.className = 'avatar';
        avatar.style.background = '#'+(Math.abs(hashCode(username))%0xFFFFFF).toString(16).padStart(6,'0');
        avatar.textContent = (username[0]||'?').toUpperCase();

        const body = document.createElement('div');
        const meta = document.createElement('div'); meta.className='meta';
        meta.innerHTML = `<span class="sender">${username}</span> • <span>${createdAt}</span>`;
        const textEl = document.createElement('div'); textEl.className='text'; textEl.textContent = obj.get('text') || '';

        body.appendChild(meta);
        body.appendChild(textEl);

        container.appendChild(avatar);
        container.appendChild(body);

        return container;
      }

      // simple hash for avatar color
      function hashCode(s){ let h=0; for(let i=0;i<s.length;i++){ h = (h<<5)-h + s.charCodeAt(i); h |= 0; } return h; }

      // Load messages (most recent 100)
      let lastLoad = 0;
      async function loadMessages(){
        try{
          const Message = Parse.Object.extend('Message');
          const q = new Parse.Query(Message);
          q.descending('createdAt');
          q.limit(100);
          const results = await q.find();

          // render in chronological order
          chatEl.innerHTML = '';
          results.reverse().forEach(m => {
            chatEl.appendChild(renderMessage(m));
          });

          // scroll to bottom
          chatEl.scrollTop = chatEl.scrollHeight;
          lastLoad = Date.now();
        }catch(err){
          console.error('loadMessages error', err);
        }
      }

      // Send message
      async function sendMessage(){
        const text = inputEl.value.trim();
        const username = (usernameEl.value || 'Anon').trim();
        if(!text) return;
        sendBtn.disabled = true;
        try{
          const Message = Parse.Object.extend('Message');
          const m = new Message();
          m.set('username', username);
          m.set('text', text);
          await m.save();
          inputEl.value = '';
          await loadMessages();
        }catch(err){
          console.error('sendMessage error', err);
          alert('Error sending message. Check console.');
        }finally{ sendBtn.disabled = false; }
      }

      sendBtn.addEventListener('click', sendMessage);
      inputEl.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)) sendMessage(); });

      // initial load + polling
      loadMessages();
      setInterval(loadMessages, 2000);

      // helpful dev note: make sure you created the 'Message' class on Back4App (or allow automatic class creation in Parse settings).
    </script>
  </body>
</html>
